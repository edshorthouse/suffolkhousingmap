<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Suffolk Housing Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html,body{margin:0;height:100%}
    #map{height:100vh;width:100vw}

    /* === UI PANELS === */
    .control-box{
      position:absolute;
      top:1rem;
      right:1rem;            /* ‑ top‑right corner */
      z-index:1000;
      background:#ffffffee;
      padding:0.75rem 1rem;
      border-radius:6px;
      font-family:sans-serif;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
      max-height:90vh;
      overflow:auto;
    }
    .control-box label{display:block;margin-bottom:.35rem;cursor:pointer}
    .swatch{
      display:inline-block;width:12px;height:12px;margin-right:6px;border-radius:2px;vertical-align:middle;
    }

    /* info textbox bottom‑left */
    #infoBox{
      position:absolute;
      bottom:1rem;
      left:1rem;
      z-index:1000;
      background:#ffffffee;
      padding:0.6rem 1rem;
      font-family:sans-serif;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
      max-width:260px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <!-- filter UI -->
  <div id="filter" class="control-box"></div>

  <!-- bottom‑left message -->
  <div id="infoBox">Click on a feature to see details.</div>

  <!-- map container -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* ========================
       1.  MAP + BASE LAYERS
       ======================== */
    const map = L.map('map');

    // CartoDB Positron — light base map (default)
    const positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution:'© OpenStreetMap © CARTO', maxZoom:19
    }).addTo(map);

    // optional extra base layer
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'© OpenStreetMap contributors', maxZoom:19
    });

    L.control.layers({"CartoDB Positron":positron,"OpenStreetMap":osm}).addTo(map);

    /* ========================
       2.  SUFFOLK OUTLINE
       ======================== */
    const boundaryURL = 'https://raw.githubusercontent.com/EdShorthouse/suffolkmap/main/suffolk.geojson';
    fetch(boundaryURL)
      .then(r=>r.ok?r.json():Promise.reject(r.statusText))
      .then(gj=>{
        const boundary = L.geoJSON(gj, {style:{color:'#000',weight:3,fillOpacity:0}}).addTo(map);
        map.fitBounds(boundary.getBounds(),{padding:[20,20]});
      })
      .catch(e=>console.warn('Boundary load failed',e));

    /* ========================
       3.  DATA + GLOBALS
       ======================== */
    let geojsonData;   // FeatureCollection
    let geojsonLayer;  // Leaflet layer

    // palette for land‑use categories (extend as needed)
    const palette = {
      'Employment':'#1f78b4',
      'Residential':'#e31a1c',
      'Mixed Use':'#33a02c',
      'Strategic Allocation':'#6a3d9a',
      'With planning permission':'#ff7f00',
      'Housing-led redevelopment':'#6b4c1a',
      'Future growth & infra':'#b15928'
    };

    fetch('./data.geojson')
      .then(r=>r.ok?r.json():Promise.reject(r.statusText))
      .then(gj=>{
        geojsonData = gj;
        populateCheckboxes(gj);
        updateMap();
      })
      .catch(e=>console.error('Could not load data.geojson',e));

    /* ========================
       4.  UI BUILDERS
       ======================== */
    function populateCheckboxes(data){
      const div=document.getElementById('filter');
      const uses=[...new Set(data.features.map(f=>f.properties.land_use).filter(Boolean))].sort();
      div.innerHTML='<strong>Land‑use</strong><br/>';
      uses.forEach(u=>{
        const id='chk-'+u.replace(/\s+/g,'-');
        const colour=palette[u]||'#999';
        const label=document.createElement('label');
        label.innerHTML=`<input type="checkbox" id="${id}" value="${u}" checked> <span class="swatch" style="background:${colour}"></span>${u}`;
        div.appendChild(label);
        document.getElementById(id).addEventListener('change',updateMap);
      });
    }

    /* ========================
       5.  DRAW / REDRAW LAYER
       ======================== */
    function updateMap(){
      const selected=Array.from(document.querySelectorAll('#filter input:checked')).map(cb=>cb.value);
      if(geojsonLayer) map.removeLayer(geojsonLayer);

      geojsonLayer=L.geoJSON(geojsonData,{
        filter:f=>selected.length===0 || selected.includes(f.properties.land_use),
        style:f=>({color:palette[f.properties.land_use]||'#666',weight:1,fillOpacity:.5}),
        onEachFeature:(f,l)=>{
          const p=f.properties||{};
          const html=`<strong>${p.address||p.site_refer||'Untitled site'}</strong><br>${p.land_use||'—'}<br>${(p.dwellings?Number(p.dwellings).toLocaleString():0)} dwellings`;
          l.bindPopup(html);
          l.on('click',()=>document.getElementById('infoBox').innerHTML=html);
        }
      }).addTo(map);
      if(geojsonLayer.getLayers().length) map.fitBounds(geojsonLayer.getBounds(),{maxZoom:14,padding:[20,20]});
    }
  </script>
</body>
</html>
